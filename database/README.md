# データベーススキーマとマイグレーション

このフォルダには、モバイルオーダーシステムのデータベーススキーマとマイグレーションスクリプトが含まれています。

## ファイル構成

### スキーマファイル

- **`schema.sql`** - 単一店舗対応の初期データベーススキーマ
  - メニューテーブル
  - 注文テーブル
  - 注文アイテムテーブル
  - サンプルデータ

- **`schema-multi-shop.sql`** - 複数店舗対応のデータベーススキーマ（推奨）
  - 店舗テーブル
  - ユーザーテーブル（スタッフ管理）
  - メニューテーブル（店舗ごと）
  - 注文テーブル（店舗ごと）
  - 注文アイテムテーブル
  - 会計テーブル
  - サンプルデータ

### マイグレーションファイル

- **`migration-simple.sql`** - 既存の単一店舗システムから複数店舗システムへの移行（簡易版）
  - `shop_id`カラムを追加
  - 既存データを保持
  - MySQL 5.7以前でも動作

- **`migration-add-shop-id.sql`** - 既存の単一店舗システムから複数店舗システムへの移行（完全版）
  - `shop_id`カラムを追加
  - 外部キー制約の追加
  - インデックスの追加
  - ユニーク制約の変更

- **`migration-add-email.sql`** - ユーザーテーブルにemailカラムを追加
  - スタッフ管理機能で使用

## 使用方法

### 新規インストール

複数店舗対応システムを新規にインストールする場合：

```sql
-- schema-multi-shop.sqlを実行
```

### 既存システムからの移行

既存の単一店舗システムから複数店舗システムに移行する場合：

1. **簡易版（推奨）**
   ```sql
   -- まずshopsテーブルを作成（schema-multi-shop.sqlの最初の部分）
   -- その後、migration-simple.sqlを実行
   ```

2. **完全版**
   ```sql
   -- migration-add-shop-id.sqlを実行
   ```

### スタッフ管理機能の追加

スタッフ管理機能を使用する場合：

```sql
-- migration-add-email.sqlを実行
```

## 実行順序

1. **新規インストール**
   ```
   schema-multi-shop.sql
   ```

2. **既存システムからの移行**
   ```
   schema-multi-shop.sql（shopsテーブル作成部分のみ）
   ↓
   migration-simple.sql または migration-add-shop-id.sql
   ↓
   migration-add-email.sql（スタッフ管理機能を使用する場合）
   ```

## 注意事項

- マイグレーション実行前に**必ずデータベースのバックアップ**を取得してください
- 本番環境では、まずテスト環境で動作確認を行ってください
- MySQL 5.7以前を使用している場合は、`migration-simple.sql`を使用してください
- `IF NOT EXISTS`構文が使えない場合は、エラーを無視して続行してください

## トラブルシューティング

### 「Duplicate column name」エラー

既にカラムが存在する場合は、そのまま続行してください。エラーは無視して問題ありません。

### 「Table doesn't exist」エラー

必要なテーブルが存在しない場合は、先に`schema-multi-shop.sql`の該当部分を実行してください。

### 外部キー制約エラー

外部キー制約でエラーが出る場合は、先に`shop_id`カラムを追加してデータを設定してから、外部キー制約を追加してください。

## 関連ドキュメント

- `../api-server/README.md` - APIサーバーのセットアップ
- `../api-server/DEPLOY.md` - デプロイ手順
- `../MIGRATION_GUIDE.md` - 詳細な移行ガイド
- `../STAFF_MANAGEMENT.md` - スタッフ管理機能の説明

