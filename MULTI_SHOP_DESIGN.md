# 複数店舗管理システム 設計書

## 概要

モバイルオーダーシステムを複数店舗を管理できるSaaS型システムに変更します。

## 主な変更点

### 1. マルチテナント対応

- 各店舗が独立したデータを持つ
- 店舗ごとのメニュー、注文、スタッフ管理
- 店舗コードによるURL分離（オプション）

### 2. 認証・認可システム

- 店舗オーナー（owner）: 店舗の全権限
- 店舗管理者（manager）: 注文管理、メニュー管理
- スタッフ（staff）: 注文管理のみ

### 3. 管理画面の追加

- 店舗管理画面（オーナー用）
- メニュー管理画面
- スタッフ管理画面
- レポート・分析画面

## データベース構造

### 新規テーブル

1. **shops** - 店舗マスタ
   - 店舗情報、設定、有効フラグ

2. **users** - ユーザーマスタ
   - 店舗オーナー、管理者、スタッフの情報
   - 役割（role）による権限管理

### 変更テーブル

1. **menus** - 店舗IDを追加
2. **orders** - 店舗IDを追加
3. **order_items** - 変更なし（orders経由で店舗を特定）
4. **payments** - 店舗IDを追加（新規）

## URL構造

### オプション1: サブドメイン方式
```
https://shop001.yourdomain.com  → 店舗1
https://shop002.yourdomain.com  → 店舗2
```

### オプション2: パス方式（推奨）
```
https://yourdomain.com/shop001  → 店舗1
https://yourdomain.com/shop002  → 店舗2
```

### オプション3: 店舗コード方式（実装予定）
```
https://yourdomain.com/customer?shop=shop001  → 店舗1の顧客画面
https://yourdomain.com/staff/login?shop=shop001  → 店舗1のスタッフ画面
```

## 機能一覧

### 顧客側（店舗ごと）

- 店舗選択画面（初回のみ）
- メニュー一覧（店舗ごと）
- 番号入力による注文
- カート機能
- 注文状況確認

### 店舗側（管理画面）

#### オーナー・管理者用

1. **ダッシュボード**
   - 今日の売上
   - 注文数
   - 人気メニュー
   - グラフ表示

2. **メニュー管理**
   - メニューの追加・編集・削除
   - カテゴリ管理
   - 在庫管理
   - 画像アップロード

3. **注文管理**
   - 注文一覧（フィルター機能）
   - 注文詳細
   - ステータス更新
   - 注文履歴

4. **スタッフ管理**（オーナーのみ）
   - スタッフの追加・編集・削除
   - 権限設定
   - ログイン履歴

5. **会計管理**
   - 会計一覧
   - 売上集計
   - レポート出力

6. **店舗設定**（オーナーのみ）
   - 店舗情報の編集
   - 営業時間設定
   - テーブル数設定
   - 通知設定

#### スタッフ用

- 注文管理
- 注文ステータス更新

### システム管理者用（オプション）

- 店舗の追加・編集・削除
- プラン管理
- 課金管理
- システム全体のレポート

## セキュリティ

1. **データ分離**
   - 店舗IDによる厳密なデータ分離
   - SQLインジェクション対策（既存のPDO使用）

2. **認証**
   - パスワードハッシュ化（password_hash使用）
   - セッション管理
   - CSRF対策

3. **権限管理**
   - 役割ベースアクセス制御（RBAC）
   - APIレベルでの権限チェック

## 実装計画

### Phase 1: データベース構造の変更
- [x] データベーススキーマの設計
- [ ] マイグレーションスクリプトの作成
- [ ] 既存データの移行

### Phase 2: APIの変更
- [ ] 店舗IDによるフィルタリング
- [ ] 認証APIの実装
- [ ] 権限チェック機能の追加

### Phase 3: フロントエンドの変更
- [ ] 店舗選択画面の追加
- [ ] 管理画面の実装
- [ ] 認証フローの実装

### Phase 4: 管理機能の実装
- [ ] メニュー管理画面
- [ ] スタッフ管理画面
- [ ] レポート機能

## 技術的な考慮事項

1. **パフォーマンス**
   - 店舗IDによるインデックス最適化
   - キャッシュ戦略の検討

2. **スケーラビリティ**
   - 店舗数の増加に対応
   - データベースパーティショニング（将来的に）

3. **バックアップ・復旧**
   - 店舗ごとのデータバックアップ
   - 災害復旧計画

